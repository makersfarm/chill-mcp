name: Create Release

on:
  push:
    branches:
      - main
    # íƒœê·¸ í‘¸ì‹œëŠ” ì œì™¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    tags-ignore:
      - '**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ëª¨ë“  íƒœê·¸ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ í•„ìš”

    - name: Get latest tag and increment version
      id: version
      run: |
        # ê¸°ì¡´ v1.0.x í˜•ì‹ì˜ íƒœê·¸ë“¤ ê°€ì ¸ì˜¤ê¸°
        git fetch --tags
        LATEST_TAG=$(git tag -l "v1.0.*" | sort -V | tail -n1)

        if [ -z "$LATEST_TAG" ]; then
          # ì²« ë²ˆì§¸ ë¦´ë¦¬ìŠ¤
          NEW_VERSION="v1.0.0"
          PATCH=0
        else
          # íŒ¨ì¹˜ ë²„ì „ ì¦ê°€
          PATCH=$(echo $LATEST_TAG | sed 's/v1.0.//')
          PATCH=$((PATCH + 1))
          NEW_VERSION="v1.0.$PATCH"
        fi

        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ New version: $NEW_VERSION"

    - name: Create and push tag
      env:
        NEW_VERSION: ${{ steps.version.outputs.new_version }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
        git push origin "$NEW_VERSION"

    - name: Create tar.gz archive
      env:
        NEW_VERSION: ${{ steps.version.outputs.new_version }}
      run: |
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p makersfarm-release

        # í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ë³µì‚¬
        cp main.py makersfarm-release/
        cp requirements.txt makersfarm-release/
        cp README.md makersfarm-release/
        cp LICENSE makersfarm-release/
        cp -r src makersfarm-release/

        # pytest.inië„ í¬í•¨ (í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡)
        if [ -f pytest.ini ]; then
          cp pytest.ini makersfarm-release/
        fi

        # tar.gz ìƒì„± (ì œì¶œ ìš”êµ¬ì‚¬í•­: ë£¨íŠ¸ì— main.pyê°€ ë°”ë¡œ ë³´ì—¬ì•¼ í•¨)
        tar -czf makersfarm.tar.gz -C makersfarm-release .

        # ê²€ì¦: ì••ì¶• í•´ì œ ì‹œ êµ¬ì¡° í™•ì¸
        echo "ğŸ“‹ Archive contents:"
        tar -tzf makersfarm.tar.gz | head -20

        # ê²€ì¦: main.pyì™€ requirements.txtê°€ ë£¨íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
        echo ""
        echo "âœ… Verification:"
        tar -tzf makersfarm.tar.gz | grep -E "^(main.py|requirements.txt)$" || echo "âŒ ERROR: main.py or requirements.txt not in root!"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.new_version }}
        name: Release ${{ steps.version.outputs.new_version }}
        body: |
          ## ChillMCP Release ${{ steps.version.outputs.new_version }}

          ### ğŸ“¦ ì œì¶œìš© íŒŒì¼
          - **íŒŒì¼ëª…**: `makersfarm.tar.gz`
          - **ì••ì¶• í•´ì œ ì‹œ**: ë£¨íŠ¸ì— `main.py`, `requirements.txt` ìœ„ì¹˜
          - **Python ë²„ì „**: 3.11

          ### ğŸš€ ì‹¤í–‰ ë°©ë²•
          ```bash
          # ì••ì¶• í•´ì œ
          tar -xzf makersfarm.tar.gz

          # ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
          python3.11 -m venv venv
          source venv/bin/activate  # macOS/Linux
          # venv\Scripts\activate  # Windows

          # ì˜ì¡´ì„± ì„¤ì¹˜
          pip install -r requirements.txt

          # ì‹¤í–‰
          python main.py
          ```

          ### ğŸ“‹ í¬í•¨ëœ íŒŒì¼
          - main.py (ë©”ì¸ ì§„ì…ì )
          - requirements.txt (ì˜ì¡´ì„± ëª©ë¡)
          - src/ (ì†ŒìŠ¤ ì½”ë“œ)
          - README.md (ë¬¸ì„œ)
          - LICENSE (ë¼ì´ì„ ìŠ¤)

          ---
          **Commit**: ${{ github.sha }}
        files: |
          makersfarm.tar.gz
        draft: false
        prerelease: false
